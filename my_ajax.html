<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AJAX CRUD with json-server (books)</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 24px; }
    h1 { margin-top: 0; }
    form, .toolbar { display: grid; grid-template-columns: repeat(6, minmax(120px, 1fr)); gap: 8px; align-items: end; }
    form input, form select { padding: 8px; }
    button { padding: 8px 12px; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background: #f3f3f3; }
    .muted { color: #666; font-size: 12px; }
    .row-actions button { margin-right: 6px; }
    .hidden { display:none; }
    .badge { display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid #ccc; font-size:12px; }
  </style>
</head>
<body>
  <h1>Books CRUD (json-server)</h1>

  <div class="toolbar">
    <button id="btnLoad">데이터 목록보기</button>
    <span class="muted">서버: <code>http://localhost:3000/books</code></span>
  </div>

  <h2>데이터 추가 / 수정</h2>
  <form id="bookForm">
    <div>
      <label>id(수정용)
        <input type="number" id="id" placeholder="수정 시 자동채움" />
      </label>
    </div>
    <div>
      <label>title
        <input type="text" id="title" required />
      </label>
    </div>
    <div>
      <label>author
        <input type="text" id="author" required />
      </label>
    </div>
    <div>
      <label>year
        <input type="number" id="year" min="0" required />
      </label>
    </div>
    <div>
      <label>status
        <select id="status">
          <option value="available">available</option>
          <option value="checked_out">checked_out</option>
        </select>
      </label>
    </div>
    <div>
      <label>rating
        <input type="number" id="rating" min="0" max="5" step="0.1" />
      </label>
    </div>
    <div>
      <button type="button" id="btnCreate">데이터추가 (POST)</button>
    </div>
    <div>
      <button type="button" id="btnUpdate">데이터수정 (PUT)</button>
    </div>
    <div>
      <button type="reset" id="btnReset">폼 리셋</button>
    </div>
  </form>

  <table id="grid">
    <thead>
      <tr>
        <th style="width:70px">id</th>
        <th>title</th>
        <th>author</th>
        <th style="width:100px">year</th>
        <th style="width:130px">status</th>
        <th style="width:90px">rating</th>
        <th style="width:180px">Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    // === 설정 ===
    const BASE = "http://localhost:3000";
    const ENDPOINT = `${BASE}/books`;

    // === 엘리먼트 ===
    const gridBody = document.querySelector("#grid tbody");
    const btnLoad = document.getElementById("btnLoad");
    const btnCreate = document.getElementById("btnCreate");
    const btnUpdate = document.getElementById("btnUpdate");
    const btnReset = document.getElementById("btnReset");

    // Form fields
    const f = {
      id:     document.getElementById("id"),
      title:  document.getElementById("title"),
      author: document.getElementById("author"),
      year:   document.getElementById("year"),
      status: document.getElementById("status"),
      
      rating: document.getElementById("rating"),
    };

    // === 공통 XHR 함수 (XMLHttpRequest) ===
    function xhr(method, url, data, onOk, onErr) {
      const x = new XMLHttpRequest();
      x.open(method, url);
      x.setRequestHeader("content-type", "application/json; charset=UTF-8");
      x.onload = () => {
        const ok = x.status >= 200 && x.status < 300;
        if (ok) onOk && onOk(x);
        else onErr ? onErr(x) : console.error(x.status, x.statusText);
      };
      x.onerror = () => onErr ? onErr(x) : console.error("Network error");
      x.send(data ? JSON.stringify(data) : null);
    }

    // === 목록 조회 (GET) ===
    function loadList() {
      xhr("GET", ENDPOINT, null, (res) => {
        const rows = JSON.parse(res.responseText);
        render(rows);
      });
    }

    function render(rows) {
      gridBody.innerHTML = rows.map(b => `
        <tr>
          <td>${b.id}</td>
          <td>${escapeHtml(b.title)}</td>
          <td>${escapeHtml(b.author)}</td>
          <td>${b.year}</td>
          <td><span class="badge">${b.status}</span></td>
          <td>${b.rating ?? ""}</td>
          <td class="row-actions">
            <button onclick='fillForm(${JSON.stringify(b).replace(/'/g,"&#39;")})'>수정</button>
            <button onclick="doDelete(${b.id})">삭제</button>
          </td>
        </tr>
      `).join("");
    }

    // === 생성 (POST) ===
    function doCreate() {
      const payload = getPayloadFromForm(false);
      if (!payload) return;
      xhr("POST", ENDPOINT, payload, () => {
        clearForm();
        loadList();
      });
    }

    // === 수정 (PUT) ===
    function doUpdate() {
      const payload = getPayloadFromForm(true);
      if (!payload) return;
      const id = Number(f.id.value);
      if (!id) return alert("수정하려면 id가 필요하다.");
      xhr("PUT", `${ENDPOINT}/${id}`, payload, () => {
        clearForm();
        loadList();
      });
    }

    // === 삭제 (DELETE) ===
    function doDelete(id) {
      if (!confirm(`정말 삭제할까요? (id=${id})`)) return;
      xhr("DELETE", `${ENDPOINT}/${id}`, null, () => loadList());
    }

    // === 폼 도우미 ===
    function fillForm(book) {
      f.id.value = book.id;
      f.title.value = book.title;
      f.author.value = book.author;
      f.year.value = book.year;
      f.status.value = book.status;
      f.rating.value = book.rating ?? "";
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function clearForm() {
      document.getElementById("bookForm").reset();
      f.id.value = "";
    }

    function getPayloadFromForm(requireId) {
      if (requireId && !f.id.value) {
        alert("id가 비어 있다.");
        return null;
      }
      if (!f.title.value || !f.author.value || !f.year.value) {
        alert("title/author/year는 필수다.");
        return null;
      }
      return {
        title: f.title.value.trim(),
        author: f.author.value.trim(),
        year: Number(f.year.value),
        status: f.status.value,
        rating: f.rating.value ? Number(f.rating.value) : null
      };
    }

    // XSS 방지용
    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;");
    }

    // === 이벤트 바인딩 ===
    window.onload = () => {
      btnLoad.addEventListener("click", loadList);
      btnCreate.addEventListener("click", doCreate);
      btnUpdate.addEventListener("click", doUpdate);
      btnReset.addEventListener("click", clearForm);
      // 초기 로드
      loadList();
    };
  </script>
</body>
</html>
